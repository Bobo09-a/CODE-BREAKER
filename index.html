<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Code Bomb ‚Äî Neo (Wizard)</title>
<style>
  :root{
    --bg1:#050612; --bg2:#090b1e; --panel:#0d1027; --panel2:#12163a; --text:#e6f7ff; --muted:#9fe3ff;
    --cyan:#00e5ff; --magenta:#ff3dff; --green:#00ffa3; --border:#1b2154;
    --glow-cyan:0 0 12px rgba(0,229,255,.45),0 0 28px rgba(0,229,255,.25);
    --glow-mag:0 0 12px rgba(255,61,255,.45),0 0 28px rgba(255,61,255,.25);
    --glow-green:0 0 12px rgba(0,255,163,.45),0 0 28px rgba(0,255,163,.25);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 800px at 70% -10%, #15205a 0, transparent 60%),
      radial-gradient(900px 600px at 0% 110%, #3a105a 0, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    display:flex;align-items:center;justify-content:center;overflow:hidden
  }
  .wrap{width:min(520px,94vw);height:min(760px,96vh);position:relative;border:1px solid var(--border);border-radius:16px;
    background:linear-gradient(180deg,rgba(15,18,45,.92),rgba(5,7,20,.92));box-shadow:0 20px 60px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.03);overflow:hidden}
  header{position:absolute;left:12px;right:12px;top:12px;z-index:3}
  .hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between}
  .chip{padding:.45rem .6rem;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg,rgba(18,22,58,.8),rgba(10,12,34,.8));box-shadow:var(--glow-cyan);font-variant-numeric:tabular-nums}
  main{position:absolute;inset:72px 12px 80px 12px;display:grid;place-items:center}
  .card{width:100%;max-width:460px;background:linear-gradient(180deg,rgba(22,26,72,.96),rgba(12,14,38,.96));border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 14px 40px rgba(0,0,0,.25)}
  h1{margin:.2rem 0 .6rem;font-size:22px;text-align:center;text-shadow:var(--glow-mag)}
  .muted{color:var(--muted);text-align:center}
  .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,rgba(25,31,84,.9),rgba(16,18,48,.9));color:var(--text);border-radius:12px;padding:.7rem 1rem;font-weight:800;letter-spacing:.02em;cursor:pointer;width:100%}
  .btn:hover{box-shadow:var(--glow-mag)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .grid3{display:grid;grid-template-columns:1fr;gap:10px}
  .level{display:flex;gap:10px}
  .level .btn{flex:1}
  .stepper{display:flex;gap:6px;justify-content:center;margin:.4rem 0}
  .dot{width:10px;height:10px;border-radius:50%;background:#18204e;border:1px solid #2a3488}
  .dot.on{background:#1fe3c2;box-shadow:var(--glow-green)}
  .expr{font-size:22px;text-align:center;margin:.4rem 0 .2rem}
  .inprow{display:flex;gap:8px;align-items:center;justify-content:center}
  input[type="number"]{width:160px;padding:.65rem .7rem;border-radius:12px;border:1px solid #2a3688;background:linear-gradient(180deg,#070a1b,#0b0f26);color:var(--text);font-weight:800;text-align:center;box-shadow:inset var(--glow-cyan)}
  .ok{color:var(--green);text-align:center;margin-top:.3rem}
  .ko{color:#ff4d6d;text-align:center;margin-top:.3rem}
  footer{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;align-items:center}
  .ghost{background:transparent;box-shadow:var(--glow-cyan) inset}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Code Bomb ‚Äî √©tapes">
  <header>
    <div class="hud">
      <div class="chip">‚è±Ô∏è <b id="time">00:30</b></div>
      <div class="chip">üéØ <b id="level">-</b></div>
      <div class="chip">‚≠ê <b id="points">0</b></div>
      <div class="chip">üß© <b id="progress">0/0</b></div>
    </div>
  </header>

  <main>
    <!-- √âtape 0 : choix niveau -->
    <section class="card" id="screen-level">
      <h1>Code Bomb</h1>
      <p class="muted" style="margin-bottom:.8rem">R√©sous chaque calcul (r√©sultat exact). Quitter l‚Äô√©cran = d√©faite imm√©diate.</p>
      <div class="level">
        <button class="btn" data-mode="easy">Niveau 1 ‚Äî 3 chiffres ‚Ä¢ 30 s</button>
        <button class="btn" data-mode="med">Niveau 2 ‚Äî 5 chiffres ‚Ä¢ 60 s</button>
        <button class="btn" data-mode="hard">Niveau 3 ‚Äî 10 chiffres ‚Ä¢ 120 s</button>
      </div>
    </section>

    <!-- √âtape jeu : une √©nigme √† la fois -->
    <section class="card" id="screen-play" style="display:none">
      <div class="stepper" id="dots"></div>
      <div class="expr" id="expr">‚Äî</div>
      <div class="inprow">
        <input id="answer" type="number" inputmode="numeric" placeholder="R√©sultat exact">
      </div>
      <div id="feedback" class="muted" aria-live="polite"></div>
      <div class="grid3" style="margin-top:10px">
        <button id="validate" class="btn">Valider</button>
        <button id="next" class="btn" style="display:none">Suivant</button>
      </div>
    </section>

    <!-- √âtape fin -->
    <section class="card" id="screen-end" style="display:none">
      <h1 id="endTitle">Fin</h1>
      <p class="muted" id="endDesc">‚Äî</p>
      <div class="grid3" style="margin-top:10px">
        <button id="copyCode" class="btn ghost" disabled>üìã Copier le code</button>
        <button id="again" class="btn">üîÅ Rejouer</button>
      </div>
    </section>
  </main>

  <footer>
    <button id="help" class="btn ghost" style="width:auto;padding:.5rem .8rem">‚ùì R√®gles</button>
    <button id="quit" class="btn ghost" style="width:auto;padding:.5rem .8rem">Quitter</button>
  </footer>
</div>

<dialog id="helpdlg" style="max-width:560px;width:92%;border:1px solid #26307a;border-radius:12px;background:linear-gradient(180deg,rgba(22,26,72,.98),rgba(12,14,38,.98));color:var(--text)">
  <div style="padding:14px">
    <h3 style="margin:.2rem 0 .4rem;text-shadow:var(--glow-cyan)">R√®gles</h3>
    <ul>
      <li>Une √©nigme √† la fois. Entre le <b>r√©sultat exact</b>.</li>
      <li>Dur√©es : 30s (N1) ‚Ä¢ 60s (N2) ‚Ä¢ 120s (N3).</li>
      <li>Quitter l‚Äô√©cran (app/onglet) = <b>d√©faite</b>.</li>
      <li>Points : +1/s pendant la partie, +10 par bonne r√©ponse. Les points cumul√©s sont sauvegard√©s.</li>
    </ul>
    <div style="text-align:right"><button id="closeHelp" class="btn" style="width:auto;padding:.5rem .8rem">OK</button></div>
  </div>
</dialog>

<script>
(()=>{'use strict';
  // ----- State -----
  let code=[], exprs=[], answers=[];
  let idx=0, startedAt=0, totalTime=0, running=false;
  let points = Number(localStorage.getItem('cb_points')||0);

  // ----- UI refs -----
  const timeEl = document.getElementById('time');
  const levelEl= document.getElementById('level');
  const pointsEl=document.getElementById('points');
  const progressEl=document.getElementById('progress');

  const scrLevel=document.getElementById('screen-level');
  const scrPlay =document.getElementById('screen-play');
  const scrEnd  =document.getElementById('screen-end');

  const dots = document.getElementById('dots');
  const expr = document.getElementById('expr');
  const answer = document.getElementById('answer');
  const feedback = document.getElementById('feedback');
  const btnValidate = document.getElementById('validate');
  const btnNext = document.getElementById('next');

  const endTitle = document.getElementById('endTitle');
  const endDesc = document.getElementById('endDesc');
  const btnCopy = document.getElementById('copyCode');
  const btnAgain= document.getElementById('again');

  const help = document.getElementById('help');
  const helpdlg = document.getElementById('helpdlg');
  const closeHelp = document.getElementById('closeHelp');
  const btnQuit = document.getElementById('quit');

  // ----- Helpers -----
  pointsEl.textContent = points;
  function savePoints(v){ points=Math.max(0,Math.floor(v)); localStorage.setItem('cb_points',points); pointsEl.textContent=points; }
  const pad=n=>String(n).padStart(2,'0');
  const fmt=ms=>{const s=Math.max(0,Math.floor(ms/1000)); return pad(Math.floor(s/60))+':'+pad(s%60);};
  const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  // G√©n√®re une expression enti√®re un peu ‚Äúclasse‚Äù
  function makeOne(){
    const t=rint(1,6); let a,b,c,res,txt;
    switch(t){
      case 1: a=rint(2,12); b=rint(2,9); c=rint(3,30); res=a*b+c; txt=`(${a} √ó ${b}) + ${c}`; break;
      case 2: a=rint(5,40); b=rint(5,40); c=rint(2,6); res=(a+b)*c; txt=`(${a} + ${b}) √ó ${c}`; break;
      case 3: a=rint(4,20); b=rint(3,9); c=rint(5,40); res=a*b-c; txt=`${a} √ó ${b} ‚àí ${c}`; break;
      case 4: c=rint(2,9); a=rint(5,20); b=rint(1,30); res=a+b; txt=`(${a*c} √∑ ${c}) + ${b}`; break;
      case 5: a=rint(20,90); b=rint(5,19); c=rint(2,7); res=(a-b)*c; txt=`(${a} ‚àí ${b}) √ó ${c}`; break;
      default: a=rint(10,70); b=rint(10,70); c=rint(10,70); res=a+b+c; txt=`${a} + ${b} + ${c}`;
    }
    return {txt,res};
  }

  function makePuzzle(len){
    code=[]; exprs=[]; answers=Array(len).fill(null);
    for(let i=0;i<len;i++){ const p=makeOne(); code.push(p.res); exprs.push(p.txt); }
  }

  function renderDots(){
    dots.innerHTML='';
    for(let i=0;i<code.length;i++){
      const d=document.createElement('div');
      d.className='dot'+(i<=idx?' on':'');
      dots.appendChild(d);
    }
  }

  function showStep(){
    renderDots();
    expr.textContent = exprs[idx];
    answer.value = answers[idx]??'';
    feedback.textContent='';
    feedback.className='muted';
    btnValidate.style.display='block';
    btnNext.style.display='none';
    answer.focus({preventScroll:true});
    progressEl.textContent = (idx)+'/'+code.length;
  }

  function start(mode){
    const conf = mode==='easy'?{len:3,secs:30,label:'N1'}
               : mode==='med' ?{len:5,secs:60,label:'N2'}
               :               {len:10,secs:120,label:'N3'};
    levelEl.textContent = conf.label;
    makePuzzle(conf.len);
    idx=0; startedAt=performance.now(); totalTime=conf.secs*1000; running=true;
    scrLevel.style.display='none'; scrEnd.style.display='none'; scrPlay.style.display='block';
    progressEl.textContent = '0/'+code.length;
    btnCopy.disabled=true;
    showStep();
    tick();
  }

  function tick(){
    if(!running) return;
    const remain=Math.max(0,totalTime-(performance.now()-startedAt));
    timeEl.textContent = fmt(remain);
    savePoints(points+(1/60)); // +1/s
    if(remain<=0){ return lose('‚èπÔ∏è Temps √©coul√©'); }
    requestAnimationFrame(tick);
  }

  function check(){
    const v = Number(answer.value);
    if(Number.isNaN(v)){ feedback.textContent='Entre un nombre'; feedback.className='ko'; return; }
    const ok = (v===code[idx]);
    answers[idx]=v;
    if(ok){
      feedback.textContent='Correct ‚úÖ (+10)'; feedback.className='ok';
      savePoints(points+10);
      btnValidate.style.display='none'; btnNext.style.display='block';
    }else{
      feedback.textContent='Rat√© ‚ùå R√©essaie'; feedback.className='ko';
    }
  }

  function next(){
    if(idx<code.length-1){ idx++; showStep(); }
    else { win(); }
  }

  function win(){
    running=false;
    scrPlay.style.display='none'; scrEnd.style.display='block';
    endTitle.textContent='‚úÖ Code trouv√© !';
    endDesc.textContent='Code : '+code.join(' - ');
    progressEl.textContent = code.length+'/'+code.length;
    btnCopy.disabled=false;
  }

  function lose(reason){
    running=false;
    scrPlay.style.display='none'; scrEnd.style.display='block';
    endTitle.textContent=reason||'‚ùå Perdu';
    endDesc.textContent='Code √©tait : '+code.join(' - ');
    btnCopy.disabled=false;
  }

  // Quitter l‚Äô√©cran = perdu
  document.addEventListener('visibilitychange', ()=>{ if(running && document.hidden) lose('‚ùå Perdu (√©cran quitt√©)'); });
  window.addEventListener('blur', ()=>{ if(running) lose('‚ùå Perdu (√©cran quitt√©)'); });

  // Events
  document.querySelectorAll('[data-mode]').forEach(b=> b.addEventListener('click', ()=> start(b.dataset.mode)));
  document.getElementById('validate').addEventListener('click', check);
  document.getElementById('next').addEventListener('click', next);
  answer.addEventListener('keydown', e=>{ if(e.key==='Enter') (btnValidate.style.display!=='none'?check():next()); });

  document.getElementById('again').addEventListener('click', ()=> location.reload());
  document.getElementById('copyCode').addEventListener('click', async()=>{
    try{ await navigator.clipboard.writeText(code.join('-')); btnCopy.textContent='Copi√© ‚úÖ'; setTimeout(()=>btnCopy.textContent='üìã Copier le code',1200);}catch{}
  });
  help.addEventListener('click', ()=> helpdlg.showModal());
  closeHelp.addEventListener('click', ()=> helpdlg.close());
  btnQuit.addEventListener('click', ()=> lose('üëã Abandon'));

})();</script>
</body>
</html>
